# List of all 2-digit FIPS codes (exclude territories if needed)
fips_list = [f"{i:02d}" for i in range(1, 57)]

results = []

for year in range(2020, 2025):
    for fips in fips_list:
        try:
            # Load data for specific year and state FIPS
            D = DOM2(year, fips)

            # Format columns as strings
            D['naics6'] = D['naics6'].astype(str).str.zfill(6)
            D['naics2'] = D['naics2'].astype(str).str.zfill(2)
            D['naics6_prefix'] = D['naics6'].str[:2]

            # Find mismatches
            mismatch_count = (D['naics6_prefix'] != D['naics2']).sum()
            total_count = len(D)

            # Save result
            results.append({
                'year': year,
                'fips': fips,
                'mismatches': mismatch_count,
                'total': total_count,
                'percent_mismatch': round(100 * mismatch_count / total_count, 2) if total_count else 0
            })

        except Exception as e:
            print(f"Error with year {year}, fips {fips}: {e}")

# Convert to DataFrame
import pandas as pd
mismatch_summary = pd.DataFrame(results)
mismatch_summary.sort_values(by='percent_mismatch', ascending=False, inplace=True)

# Show the summary
import ace_tools as tools; tools.display_dataframe_to_user(name="Mismatch Summary", dataframe=mismatch_summary)


import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# Load the mismatch summary file just created
mismatch_summary = pd.read_csv('/mnt/data/file-EavHHTRooVcfY49t7Dkh92')  # Replace with real df if already available

# Plotting percent mismatch by year and FIPS
plt.figure(figsize=(14, 8))
sns.barplot(data=mismatch_summary, x='year', y='percent_mismatch', hue='fips')
plt.title('Percent of NAICS6 Prefix â‰  NAICS2 by Year and State (FIPS)')
plt.xlabel('Year')
plt.ylabel('Percent Mismatch')
plt.legend(title='State FIPS', bbox_to_anchor=(1.05, 1), loc='upper left')
plt.tight_layout()
plt.show()
