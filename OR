import oracledb
import pandas as pd

def id_frequency_distribution(conn, table_name, yr, qtr):

    query = f"""
    WITH freq_counts AS (
        SELECT
            ID,
            COUNT(*) AS freq
        FROM {table_name}
        WHERE YR = :yr
          AND QTR = :qtr
        GROUP BY ID
    ),
    dist AS (
        SELECT
            freq,
            COUNT(*) AS num_ids
        FROM freq_counts
        GROUP BY freq
    ),
    total_ids AS (
        SELECT SUM(num_ids) AS total
        FROM dist
    )
    SELECT
        d.freq,
        d.num_ids,
        d.num_ids / t.total AS probability
    FROM dist d
    CROSS JOIN total_ids t
    ORDER BY d.freq
    """

    return pd.read_sql(
        query,
        conn,
        params={"yr": yr, "qtr": qtr}
    )
