import pandas as pd
from concurrent.futures import ThreadPoolExecutor, as_completed

def process_one_combo(fips, year, qtr):
    """Process one (fips, year, quarter) combination."""
    try:
        df = Extract_QTR(fips, year, qtr)

        # Filter wages > $1M
        df_hi = df[df["WAGE"] > 1_000_000].copy()
        if df_hi.empty:
            return None
        
        # Group by state (st)
        summary = df_hi.groupby("st").agg(
            high_wage_count=("UI", "nunique"),
            max_wage=("WAGE", "max"),
            min_wage=("WAGE", "min"),
            total_high_wages=("WAGE", "sum")
        ).reset_index()

        summary["fips"] = fips
        summary["year"] = year
        summary["quarter"] = qtr

        return summary

    except Exception as e:
        print(f"Error: fips={fips}, year={year}, qtr={qtr}: {e}")
        return None


def high_wage_summary_mt(fips_list, start_year=2020, end_year=2025, max_workers=24):
    """Multithreaded processing for all fips, years, quarters."""
    tasks = []

    with ThreadPoolExecutor(max_workers=max_workers) as executor:

        for fips in fips_list:
            for year in range(start_year, end_year + 1):

                if year == 2025:
                    quarters = [1]      # Only 2025 Q1
                else:
                    quarters = [1, 2, 3, 4]

                for qtr in quarters:
                    tasks.append(
                        executor.submit(process_one_combo, fips, year, qtr)
                    )

        # Collect results
        results = []
        for t in as_completed(tasks):
            r = t.result()
            if r is not None:
                results.append(r)

    return pd.concat(results, ignore_index=True) if results else pd.DataFrame()


ALL_FIPS = [1, 2, 4, 5, 6]  # example subset â€” replace with full FIPS list

df_high_mt = high_wage_summary_mt(ALL_FIPS)
df_high_mt

