import oracledb
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

def id_frequency_distribution(conn, table_name, yr, qtr):
    query = f"""
    WITH freq_counts AS (
        SELECT ID, COUNT(*) AS freq
        FROM {table_name}
        WHERE YR = :yr AND QTR = :qtr
        GROUP BY ID
    )
    SELECT
        freq,
        COUNT(*) AS num_ids,
        COUNT(*) * 1.0 / SUM(COUNT(*)) OVER () AS probability
    FROM freq_counts
    GROUP BY freq
    ORDER BY freq
    """
    return pd.read_sql(query, conn, params={"yr": yr, "qtr": qtr})

def shannon_entropy(p):
    p = np.array(p)
    p = p[p > 0]
    return -np.sum(p * np.log2(p))

def gini_coefficient(x):
    x = np.array(x)
    if np.amin(x) < 0:
        x -= np.amin(x)
    x += 1e-9
    x = np.sort(x)
    n = len(x)
    index = np.arange(1, n + 1)
    return (2 * np.sum(index * x)) / (n * np.sum(x)) - (n + 1) / n

def analyze_id_distribution(conn, table_name, yr, qtr):
    df = id_frequency_distribution(conn, table_name, yr, qtr)

    entropy = shannon_entropy(df["probability"])
    gini = gini_coefficient(df["num_ids"])

    plt.figure()
    plt.loglog(df["freq"], df["probability"], marker="o")
    plt.xlabel("ID Frequency (log scale)")
    plt.ylabel("Probability (log scale)")
    plt.title(f"ID Frequency Distribution: {yr} Q{qtr}")
    plt.grid(True, which="both")
    plt.show()

    return {
        "entropy": entropy,
        "gini": gini,
        "distribution": df
    }

# Example (requires active Oracle connection)
# conn = oracledb.connect(user="user", password="pw", dsn="dsn")
# result = analyze_id_distribution(conn, "WAGE_TABLE", 2024, 4)
# print("Entropy:", result["entropy"])
# print("Gini:", result["gini"])

