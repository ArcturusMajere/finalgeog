import pandas as pd
from concurrent.futures import ThreadPoolExecutor, as_completed

def threaded_wage_naics2_dups_2024q3(STATES, max_workers=8):
    results = []
    def worker(state):
        df = get_cohort(state, 2024, 3)
        if df is None or df.empty:
            return
        # group by NAICS2 and WAGE, count occurrences
        grp = df.groupby(['naics2', 'WAGE']).size()
        dup = grp[grp > 1].reset_index(name='count')
        if dup.empty:
            return
        dup['state'] = state
        results.append(dup[['state', 'naics2', 'WAGE', 'count']])
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        futures = [executor.submit(worker, s) for s in STATES]
        for f in as_completed(futures):
            f.result()
    return pd.concat(results, ignore_index=True) if results else pd.DataFrame(
        columns=['state', 'naics2', 'WAGE', 'count']
    )
