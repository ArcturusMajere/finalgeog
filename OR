
import pandas as pd

def read_csv_files(file_paths,dtype_backend="pyarrow"):
    dataframes=[]
    for path in file_paths:
        try:
            dataframes.append(pd.read_csv(path,dtype_backend=dtype_backend))
        except Exception as e:
            raise RuntimeError(f"Error reading {path}: {e}")
    return dataframes

def compare_data_types(dataframes):
    data_types={}
    for i,df in enumerate(dataframes):
        data_types[i]=df.dtypes.to_dict()
    return data_types

def check_and_standardize_columns(dataframes,mode="union",strip=True,upper=False,rename_maps=None):
    if not isinstance(dataframes,list) or len(dataframes)==0:
        raise ValueError("dataframes must be a non-empty list")
    out=[]
    for i,df in enumerate(dataframes):
        d=df.copy()
        cols=[str(c) for c in d.columns]
        if strip: cols=[c.strip() for c in cols]
        if upper: cols=[c.upper() for c in cols]
        d.columns=cols
        if rename_maps and i < len(rename_maps) and rename_maps[i]:
            d=d.rename(columns=rename_maps[i])
        out.append(d)
    sets=[set(d.columns) for d in out]
    if mode=="union":
        cols=sorted(set.union(*sets))
    elif mode=="intersection":
        cols=sorted(set.intersection(*sets))
    else:
        raise ValueError("mode must be 'union' or 'intersection'")
    out=[d.reindex(columns=cols) for d in out]
    return out

def sort_dataframes(dataframes,column_names,ascending=True):
    sorted_dfs=[]
    for df in dataframes:
        if not all(col in df.columns for col in column_names):
            missing=[c for c in column_names if c not in df.columns]
            raise ValueError(f"Missing sort columns: {missing}")
        sorted_dfs.append(df.sort_values(by=column_names,ascending=ascending,kind="mergesort"))
    return sorted_dfs

def reset_indexes(dataframes):
    return [df.reset_index(drop=True) for df in dataframes]

def _coerce_common_dtypes(dataframes):
    cols=sorted(set.intersection(*[set(df.columns) for df in dataframes]))
    out=[df.copy() for df in dataframes]
    for c in cols:
        dts=[o[c].dtype for o in out]
        if any(pd.api.types.is_datetime64_any_dtype(t) for t in dts):
            out=[o.assign(**{c: pd.to_datetime(o[c],errors="coerce")}) for o in out]
        elif any(pd.api.types.is_numeric_dtype(t) for t in dts):
            out=[o.assign(**{c: pd.to_numeric(o[c],errors="coerce")}) for o in out]
        else:
            out=[o.assign(**{c: o[c].astype("string")}) for o in out]
    return out

def compare_dataframes(dataframes,key_cols=None,reference_index=0,keep_equal=False,keep_shape=True,column_mode="union"):
    if not isinstance(dataframes,list) or len(dataframes)<2:
        raise ValueError("Input must be a list of at least two DataFrames.")
    dfs=check_and_standardize_columns(dataframes,mode=column_mode)
    dfs=_coerce_common_dtypes(dfs)
    if key_cols:
        for k in key_cols:
            for i,df in enumerate(dfs):
                if k not in df.columns:
                    raise KeyError(f"Missing key column {k} in dataframe {i}")
        dfs=[df.sort_values(key_cols,kind="mergesort").set_index(key_cols,drop=False) for df in dfs]
        dfs=[df.sort_index() for df in dfs]
    else:
        dfs=reset_indexes(dfs)
    ref=dfs[reference_index]
    results=[]
    for i,df in enumerate(dfs):
        if i==reference_index:
            continue
        if key_cols:
            common=ref.index.intersection(df.index)
            left_only=ref.index.difference(df.index)
            right_only=df.index.difference(ref.index)
            diff=ref.loc[common].compare(df.loc[common],keep_equal=keep_equal,keep_shape=keep_shape)
            results.append({"compared_index":i,"diff":diff,"left_only_keys":left_only,"right_only_keys":right_only})
        else:
            if ref.shape!=df.shape or list(ref.columns)!=list(df.columns):
                raise ValueError("Without key_cols, DataFrames must have identical shape and columns after standardization.")
            diff=ref.compare(df,keep_equal=keep_equal,keep_shape=keep_shape)
            results.append({"compared_index":i,"diff":diff})
    return results


file_paths=["wage_summary_AWS.csv","wage_summary_Oracle.csv"]
dfs=read_csv_files(file_paths)
dfs=check_and_standardize_columns(dfs,mode="union")
dfs=sort_dataframes(dfs,["STATE_CODE","YR","QTR"])
results=compare_dataframes(dfs,key_cols=["STATE_CODE","YR","QTR"],reference_index=0,keep_equal=False,keep_shape=True)

for r in results:
    print("Compared DF index:",r["compared_index"])
    print("Only in reference:",len(r.get("left_only_keys",[])))
    print("Only in compared:",len(r.get("right_only_keys",[])))
    print(r["diff"].head(50))
