
import pandas as pd
from concurrent.futures import ThreadPoolExecutor, as_completed

def process_one_combo(fips, year, qtr):
    """Return only fips and count of wages > $1M."""
    
    df = Extract_QTR(fips, year, qtr)       # output contains 'state', not fips
    df["fips_used"] = str(fips)

    # Filter >$1,000,000
    df_hi = df[df["WAGE"] > 1_000_000]

    # If none, return zero for that period
    return pd.DataFrame({
        "fips_used": [str(fips)],
        "year": [year],
        "quarter": [qtr],
        "high_wage_count": [len(df_hi)]
    })


def high_wage_summary_mt(fips_list, start_year=2020, end_year=2025, max_workers=24):
    """Multithreaded processing, returning fips + count only."""

    tasks = []
    with ThreadPoolExecutor(max_workers=max_workers) as executor:

        for fips in fips_list:
            for year in range(start_year, end_year + 1):

                quarters = [1] if year == 2025 else [1, 2, 3, 4]

                for qtr in quarters:
                    tasks.append(
                        executor.submit(process_one_combo, fips, year, qtr)
                    )

        results = []
        for t in as_completed(tasks):
            results.append(t.result())

    return pd.concat(results, ignore_index=True)
